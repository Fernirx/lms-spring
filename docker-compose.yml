version: '3.9'

services:
  mysql:
    image: mysql:8.0
    container_name: lms-mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "${DB_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/sql/init_lms_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - lms-net

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${APP_NAME}
    depends_on:
      - mysql
    ports:
      - "${HOST_PORT}:${SERVER_PORT}"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      # === DATABASE ===
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      DATABASE_TIMEZONE: ${DATABASE_TIMEZONE}

      # === APP / SERVER ===
      APP_NAME: ${APP_NAME}
      SERVER_PORT: ${SERVER_PORT}
      SERVER_CONTEXT_PATH: ${SERVER_CONTEXT_PATH}

      # === JWT ===
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
      JWT_RESET_PASSWORD_EXPIRATION: ${JWT_RESET_PASSWORD_EXPIRATION}
      JWT_ISSUER: ${JWT_ISSUER}

      # === Frontend ===
      FRONTEND_LOGIN_URL: ${FRONTEND_LOGIN_URL}

      # === OTP CACHE ===
      OTP_MAXIMUM_SIZE: ${OTP_MAXIMUM_SIZE}
      OTP_EXPIRE_AFTER: ${OTP_EXPIRE_AFTER}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS}
      OTP_INITIAL_CAPACITY: ${OTP_INITIAL_CAPACITY}
      OTP_MAX_RESEND: ${OTP_MAX_RESEND}
      OTP_RESEND_COOLDOWN: ${OTP_RESEND_COOLDOWN}

      # === JPA / HIBERNATE ===
      JPA_DDL_AUTO: ${JPA_DDL_AUTO}
      JPA_SHOW_SQL: ${JPA_SHOW_SQL}
      HIBERNATE_FORMAT_SQL: ${HIBERNATE_FORMAT_SQL}

      # === FILE UPLOAD ===
      MAX_FILE_SIZE: ${MAX_FILE_SIZE}
      MAX_REQUEST_SIZE: ${MAX_REQUEST_SIZE}

      # === SWAGGER ===
      SWAGGER_API_DOCS_PATH: ${SWAGGER_API_DOCS_PATH}
      SWAGGER_UI_PATH: ${SWAGGER_UI_PATH}
      SWAGGER_OPERATIONS_SORTER: ${SWAGGER_OPERATIONS_SORTER}
      SWAGGER_TAGS_SORTER: ${SWAGGER_TAGS_SORTER}
      SWAGGER_DISPLAY_REQUEST_DURATION: ${SWAGGER_DISPLAY_REQUEST_DURATION}
      SWAGGER_SHOW_ACTUATOR: ${SWAGGER_SHOW_ACTUATOR}

      # === ACTUATOR ===
      ACTUATOR_EXPOSED_ENDPOINTS: ${ACTUATOR_EXPOSED_ENDPOINTS}
      ACTUATOR_HEALTH_SHOW_DETAILS: ${ACTUATOR_HEALTH_SHOW_DETAILS}

      # === LOGGING ===
      LOG_LEVEL_ROOT: ${LOG_LEVEL_ROOT}
      LOG_LEVEL_SPRING_WEB: ${LOG_LEVEL_SPRING_WEB}
      LOG_LEVEL_APP: ${LOG_LEVEL_APP}

    networks:
      - lms-net

volumes:
  mysql_data:

networks:
  lms-net:
